<div class="container wrapper">
	<div class="starter-template">
		<h1><img src="/img/playlists.png" alt="" />Player</h1>
		<div class="player-page">
			<div id="player"></div>
			<div class="buttons">
				<button type="button" class="blue-styled-button togglePlay">Pause</button>
				<button type="button" class="blue-styled-button volBtn" id="up">Volume +</button>
				<button type="button" class="blue-styled-button volBtn" id="down">Volume -</button>
				<button type="button" class="blue-styled-button skipBtn">Skip</button>
			</div>
			<div class="currentsong"></div>
			<div class="currentvolume"></div>
		</div>
		<div class="player-songlist songlist">
			<table class="datatable"><thead><th>#</th><th>Title</th><th>Requested</th></thead><tbody></tbody></table>
		</div>
	</div>
</div>
<script src="https://ttv-api.s3.amazonaws.com/twitch.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="/js/datatables.js"></script>
<script>
var player;
var channelData = '';
passedPage = 'player';
getChannelName('{{=it.passedUser}}').then(channelName => {
	buildChannelDataString(channelName).then(channelRes => {
		channelData = channelRes;
		$.ajaxSetup({ cache: false });

		$('.volBtn').click(function(e) {
			e.preventDefault();
			var direction = $(this).attr('id');
			getVolume(channelData).then(currentVolume => {
				var newVol = 0;
				if (direction == 'up') {
					if (currentVolume < 90) {
						newVol = Number(currentVolume) + 10;
					} else {
						newVol = 100;
					};
				} else {
					if (currentVolume > 10) {
						newVol = currentVolume - 10;
					} else {
						newVol = 10;
					};
				};
				updateVolume(channelData,newVol).then(newVol => {
					player.setVolume(newVol);
					volumeReader();
				});
			});
		});

		$('.togglePlay').click(function(e) {
			e.preventDefault();
			if ($(this).text() == 'Pause') {
				player.pauseVideo();
				$(this).text('Play');
				updateMusicStatus(channelData,'pause');
			} else {
				player.playVideo();
				$(this).text('Pause');
				updateMusicStatus(channelData,'play');
			};
		});
	});
});

$('.skipBtn').click(function(e) {
	e.preventDefault();
	loadNextSong();
});

function loadPlayer() {
	$.ajax({
		url: '/getsonglist',
		data: channelData,
		type: 'POST',
		success: function(data) {
			if (data[0] != undefined) {

				player = new YT.Player('player', {
					videoId: data[0]['songID'],
					events: {
						'onReady': onPlayerReady,
						'onStateChange': onPlayerStateChange
					}
				});
				loadSonglist(channelData,'player').then(songlist => {
					if (songlist) {
						dataTableStartSize = '5';
						buildDataTable(songlist,'.datatable',dataTableStartSize);
						checkForSonglistChanges(channelData,songlist,dataTableStartSize,passedPage);
					} else {
						$('.datatable tbody').hide();
						$('.songlist').html("Currently no songs in the queue!");
					};
				});
			} else {
				$('#player').html('Currently no songs in the queue!');
				this['checkSkippedSongsInterval'] = setInterval(function() {
					checkForSkippedSongs();
				}, 1000);
			};
		}
	});
}

function loadNextSong() {
	$.ajax({
		url: '/loadnextsong',
		data: channelData,
		type: 'POST',
		success: function(data) {
			if (data == 'empty') {
				console.log(data);
			} else {
				player.loadVideoById(data);
				$('.togglePlay').text('Pause');
				loadSonglist(channelData,'player');
			};
		}
	});
}

function onPlayerReady(event) {
	event.target.playVideo();
	checkMusicStatus();
	this['musicStatusInterval'] = setInterval(function() {
		checkMusicStatus();
	}, 1000);

	volumeReader();
	setInterval(function(){volumeReader()}, 1000);


	checkForSkippedSongs();
	this['checkSkippedSongsInterval'] = setInterval(function() {
		checkForSkippedSongs();
	}, 1000);
};

function onPlayerStateChange(event) {
	if (event.data == 0) {
		loadNextSong();
	};
}

function volumeReader() {
	getVolume(channelData).then(currentVolume => {
		player.setVolume(currentVolume);
		$('.currentvolume').html('<strong>Current Volume: </strong>' + currentVolume);
	});
};

function checkMusicStatus() {
	getMusicStatus(channelData).then(musicStatus => {
		if (musicStatus[0]['musicStatus'] == 'pause') {
			player.pauseVideo();
			$('.togglePlay').text('Play');
		} else {
			player.playVideo();
			$('.togglePlay').text('Pause');
		};
	});
};

function checkForSkippedSongs() {
	if (player) {
		var currentPlayingID = player.getVideoUrl().split('v=');
		$.ajax({
			url: '/getsonglist',
			data: channelData,
			type: 'POST',
			cache: false,
			success: function(data) {
				if (data[0] != undefined) {
					if (data[0]['songID'] == currentPlayingID[1]) {
					} else {
						player.loadVideoById(data[0]['songID']);
					};
				} else {
					player.loadVideoById('');
				};
			}
		});
	} else {
		$.ajax({
			url: '/getsonglist',
			data: channelData,
			type: 'POST',
			cache: false,
			success: function(data) {
				if (data) {
					location.reload();
				};
			}
		});
	}
};

function onYouTubeIframeAPIReady() {
	loadPlayer();
};

</script>